<?php

namespace App\Http\Controllers\Api\V2\Front\ListingFrontC;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Route;
use LaravelJsonApi\Core\Document\Error;
use LaravelJsonApi\Core\Responses\ErrorResponse;
use LaravelJsonApi\Core\Responses\DataResponse;
use LaravelJsonApi\Laravel\Http\Controllers\JsonApiController;
use Illuminate\Support\Facades\Storage;
use App\Enums\ItemStatus;







use LaravelJsonApi\Contracts\Store\Store;
use LaravelJsonApi\Contracts\Routing\Route as JsonApiRoute;


use App\Models\Review;

use App\Models\Reviewreply;

use App\Models\Favorite;

use App\Models\Listing;
use App\Models\User;

use App\Models\Reservation;

use App\Models\Onlinestore;



use App\Models\Billiard;
use App\Models\Boxing;
use App\Models\Diving  ;
use App\Models\Football  ;
use App\Models\Golf  ;
use App\Models\Hunting  ;
use App\Models\Musculation  ;
use App\Models\Surf  ;
use App\Models\Tennis  ;



use App\Models\Audio  ;
use App\Models\Camera  ;
use App\Models\Charger  ;
use App\Models\Drone  ;
use App\Models\Gaming  ;
use App\Models\Laptop  ;
use App\Models\Lighting  ;
use App\Models\Printer  ;
use App\Models\Router  ;
use App\Models\Tablette  ;


use App\Models\Eclairage  ;
use App\Models\Mobilier  ;
use App\Models\Photographie  ;
use App\Models\Sonorisation  ;
use App\Models\Tente  ;


use App\Models\Clothes  ;
use App\Models\Jewelry  ;


use App\Models\Apartment  ;
use App\Models\Bureaux  ;
use App\Models\Magasin  ;
use App\Models\Maison  ;
use App\Models\Riad  ;
use App\Models\Terrain  ;
use App\Models\Villa  ;


use App\Models\Activity  ;
use App\Models\Livre  ;
use App\Models\Musical  ;


use App\Models\Furniture  ;
use App\Models\Houseappliance  ;


use App\Models\Electricaltool  ;
use App\Models\Ladder  ;
use App\Models\Mechanicaltool  ;
use App\Models\Powertool  ;
use App\Models\Pressurewasher  ;



use App\Models\Service  ;



use App\Models\Boat  ;
use App\Models\Camion  ;
use App\Models\Caravan  ;
use App\Models\Car  ;
use App\Models\Engin  ;
use App\Models\Moto  ;
use App\Models\Scooter  ;
use App\Models\Taxiaeroport  ;
use App\Models\Transportation  ;
use App\Models\Velo  ;




use App\Models\Billiardsimg;
use App\Models\Boxingsimg;
use App\Models\Divingsimg;
use App\Models\Footballsimg;
use App\Models\Golfsimg;
use App\Models\Huntingsimg;
use App\Models\Musculationsimg;
use App\Models\Surfsimg;
use App\Models\Tennisimg;

use App\Models\Audiosimg;
use App\Models\Camerasimg;
use App\Models\Chargersimg;
use App\Models\Dronesimg;
use App\Models\Gamingsimg;
use App\Models\Laptopsimg;
use App\Models\Lightingsimg;
use App\Models\Printersimg;
use App\Models\Routersimg;
use App\Models\Tablettesimg;

use App\Models\Eclairagesimg;
use App\Models\Mobiliersimg;
use App\Models\Photographiesimg;
use App\Models\Sonorisationsimg;
use App\Models\Tentesimg;

use App\Models\Clothesimg;
use App\Models\Jewelrysimg;

use App\Models\Apartmentsimg;
use App\Models\Bureauxsimg;
use App\Models\Magasinsimg;
use App\Models\Maisonsimg;
use App\Models\Riadsimg;
use App\Models\Terrainsimg;
use App\Models\Villasimg;

use App\Models\Activitiesimg;
use App\Models\Livresimg;
use App\Models\Musicalsimg;

use App\Models\Furnituresimg;
use App\Models\Houseappliancesimg;

use App\Models\Electricaltoolsimg;
use App\Models\Laddersimg;
use App\Models\Mechanicaltoolsimg;
use App\Models\Powertoolsimg;
use App\Models\Pressurewashersimg;

use App\Models\Servicesimg;

use App\Models\Boatsimg;
use App\Models\Camionsimg;
use App\Models\Caravansimg;
use App\Models\Carsimg;
use App\Models\Enginsimg;
use App\Models\Motosimg;
use App\Models\Scootersimg;
use App\Models\Taxiaeroportsimg;
use App\Models\Transportationsimg;
use App\Models\Velosimg;

use App\Models\Generaleinfo;






class ListingFrontController extends JsonApiController
{





    public function getListing(Request $request, $category, $url)
    {








        $authuser = Auth::user();






        if ($authuser) {


            $favorites = Favorite::where('user_id', $authuser->id)->get();







            $billiard_ids = array_filter($favorites->pluck('billiard_id')->toArray());
            $boxing_ids = array_filter($favorites->pluck('boxing_id')->toArray());
            $diving_ids = array_filter($favorites->pluck('diving_id')->toArray());
            $football_ids = array_filter($favorites->pluck('football_id')->toArray());
            $golf_ids = array_filter($favorites->pluck('golf_id')->toArray());
            $hunting_ids = array_filter($favorites->pluck('hunting_id')->toArray());
            $musculation_ids = array_filter($favorites->pluck('musculation_id')->toArray());
            $surf_ids = array_filter($favorites->pluck('surf_id')->toArray());
            $tennis_ids = array_filter($favorites->pluck('tennis_id')->toArray());
            $audio_ids = array_filter($favorites->pluck('audio_id')->toArray());
            $camera_ids = array_filter($favorites->pluck('camera_id')->toArray());
            $charger_ids = array_filter($favorites->pluck('charger_id')->toArray());
            $drone_ids = array_filter($favorites->pluck('drone_id')->toArray());
            $gaming_ids = array_filter($favorites->pluck('gaming_id')->toArray());
            $laptop_ids = array_filter($favorites->pluck('laptop_id')->toArray());
            $lighting_ids = array_filter($favorites->pluck('lighting_id')->toArray());
            $printer_ids = array_filter($favorites->pluck('printer_id')->toArray());
            $router_ids = array_filter($favorites->pluck('router_id')->toArray());
            $tablette_ids = array_filter($favorites->pluck('tablette_id')->toArray());
            $eclairage_ids = array_filter($favorites->pluck('eclairage_id')->toArray());
            $mobilier_ids = array_filter($favorites->pluck('mobilier_id')->toArray());
            $photographie_ids = array_filter($favorites->pluck('photographie_id')->toArray());
            $sonorisation_ids = array_filter($favorites->pluck('sonorisation_id')->toArray());
            $tente_ids = array_filter($favorites->pluck('tente_id')->toArray());
            $clothes_ids = array_filter($favorites->pluck('clothes_id')->toArray());
            $jewelry_ids = array_filter($favorites->pluck('jewelry_id')->toArray());
            $apartment_ids = array_filter($favorites->pluck('apartment_id')->toArray());
            $bureaux_ids = array_filter($favorites->pluck('bureaux_id')->toArray());
            $magasin_ids = array_filter($favorites->pluck('magasin_id')->toArray());
            $maison_ids = array_filter($favorites->pluck('maison_id')->toArray());
            $riad_ids = array_filter($favorites->pluck('riad_id')->toArray());
            $terrain_ids = array_filter($favorites->pluck('terrain_id')->toArray());
            $villa_ids = array_filter($favorites->pluck('villa_id')->toArray());
            $activity_ids = array_filter($favorites->pluck('activity_id')->toArray());
            $livre_ids = array_filter($favorites->pluck('livre_id')->toArray());
            $musical_ids = array_filter($favorites->pluck('musical_id')->toArray());
            $furniture_ids = array_filter($favorites->pluck('furniture_id')->toArray());
            $houseappliance_ids = array_filter($favorites->pluck('houseappliance_id')->toArray());
            $electricaltool_ids = array_filter($favorites->pluck('electricaltool_id')->toArray());
            $ladder_ids = array_filter($favorites->pluck('ladder_id')->toArray());
            $mechanicaltool_ids = array_filter($favorites->pluck('mechanicaltool_id')->toArray());
            $powertool_ids = array_filter($favorites->pluck('powertool_id')->toArray());
            $pressurewasher_ids = array_filter($favorites->pluck('pressurewasher_id')->toArray());
            $service_ids = array_filter($favorites->pluck('service_id')->toArray());
            $boat_ids = array_filter($favorites->pluck('boat_id')->toArray());
            $camion_ids = array_filter($favorites->pluck('camion_id')->toArray());
            $caravan_ids = array_filter($favorites->pluck('caravan_id')->toArray());
            $car_ids = array_filter($favorites->pluck('car_id')->toArray());
            $engin_ids = array_filter($favorites->pluck('engin_id')->toArray());
            $moto_ids = array_filter($favorites->pluck('moto_id')->toArray());
            $scooter_ids = array_filter($favorites->pluck('scooter_id')->toArray());
            $taxiaeroport_ids = array_filter($favorites->pluck('taxiaeroport_id')->toArray());
            $transportation_ids = array_filter($favorites->pluck('transportation_id')->toArray());
            $velo_ids = array_filter($favorites->pluck('velo_id')->toArray());




            $favoriteIds = array_merge(
                $billiard_ids,
                $boxing_ids,
                $diving_ids,
                $football_ids,
                $golf_ids,
                $hunting_ids,
                $musculation_ids,
                $surf_ids,
                $tennis_ids,
                $audio_ids,
                $camera_ids,
                $charger_ids,
                $drone_ids,
                $gaming_ids,
                $laptop_ids,
                $lighting_ids,
                $printer_ids,
                $router_ids,
                $tablette_ids,
                $eclairage_ids,
                $mobilier_ids,
                $photographie_ids,
                $sonorisation_ids,
                $tente_ids,
                $clothes_ids,
                $jewelry_ids,
                $apartment_ids,
                $bureaux_ids,
                $magasin_ids,
                $maison_ids,
                $riad_ids,
                $terrain_ids,
                $villa_ids,
                $activity_ids,
                $livre_ids,
                $musical_ids,
                $furniture_ids,
                $houseappliance_ids,
                $electricaltool_ids,
                $ladder_ids,
                $mechanicaltool_ids,
                $powertool_ids,
                $pressurewasher_ids,
                $service_ids,
                $boat_ids,
                $camion_ids,
                $caravan_ids,
                $car_ids,
                $engin_ids,
                $moto_ids,
                $scooter_ids,
                $taxiaeroport_ids,
                $transportation_ids,
                $velo_ids
            );


        }













        switch ($category) {



            case 'billiards':


                        $listingcategory = Billiard::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,







                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'table_brand' => $listingcategory->table_brand,
                                        'condition' => $listingcategory->condition,
                                        'balls_design' => $listingcategory->balls_design,
                                        'bridge_stick' => $listingcategory->bridge_stick,
                                        'chalk' => $listingcategory->chalk,
                                        'other_information' => $listingcategory->scoreboards,
                                        'more_details' => $listingcategory->more_details,

                                    ],

                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,


                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {
                                                $replyUser = User::find($reply->user_id);


                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,

                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Billiardsimg::where('billiard_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,

                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place




                                    'recentlistings' => Billiard::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        return [

                                            'attributes' => [

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'billiards',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                            'picture' => $recentlisting->picture,


                                            'averageRating' => $averageRating,

                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            'phone' => $recentlisting->phone,


                                            'seller' => [
                                                'name' => $user->name,
                                                'id' => $user->id,
                                                'profile_image' => $user->profile_image,
                                                'created_at' => $user->created_at->toIso8601String(),

                                            ],

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Billiard::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,


                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Billiard::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Billiard::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Billiard::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Billiard::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Billiard::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Billiard::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Billiard::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Billiard::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Billiard::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Billiard::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Billiard::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Billiard::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Billiard::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Billiard::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Billiard::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Billiard::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'billiards',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];



                        // Ensure JSON:API compliance
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' key if user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        return response()->json($responseData);





                break;





            case 'boxings':


                        $listingcategory = Boxing::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                    'brand_name' => $listingcategory->brand_name,
                                    'ring_dimensions' => $listingcategory->ring_dimensions,
                                    'padding_thickness' => $listingcategory->padding_thickness,
                                    'boxing_clothing' => $listingcategory->boxing_clothing,
                                    'other_equipment' => $listingcategory->other_equipment,
                                    'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {
                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Boxingsimg::where('boxing_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Boxing::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,


                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'boxings',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Boxing::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,


                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Boxing::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Boxing::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Boxing::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Boxing::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Boxing::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Boxing::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Boxing::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Boxing::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Boxing::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Boxing::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Boxing::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Boxing::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Boxing::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Boxing::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Boxing::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Boxing::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boxings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),














                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;






            case 'divings':




                        $listingcategory = Diving::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'brand_name' => $listingcategory->brand_name,
                                        'material' => $listingcategory->material,
                                        'other_equipment' => $listingcategory->other_equipment,
                                        'more_details' => $listingcategory->more_details,

                                    ],



                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Divingsimg::where('diving_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Diving::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'divings',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,


                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Diving::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,


                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Diving::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Diving::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Diving::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Diving::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Diving::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Diving::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Diving::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Diving::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Diving::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Diving::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Diving::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Diving::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Diving::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Diving::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Diving::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Diving::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'divings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),












                                ],

                        ];



                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;







            case 'footballs':





                        $listingcategory = Football::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();


                        $userStore = Onlinestore::where('user_id', $user->id)->first();

                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'type' => $listingcategory->type,
                                        'equipment' => $listingcategory->equipment,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Footballsimg::where('football_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Football::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'footballs',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Football::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,


                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Football::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Football::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Football::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Football::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Football::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Football::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Football::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Football::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Football::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Football::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Football::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Football::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Football::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Football::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Football::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Football::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'footballs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),









                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;







            case 'golfs':



                        $listingcategory = Golf::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'clothing' => $listingcategory->clothing,
                                        'golf_cars' => $listingcategory->golf_cars,
                                        'other_equipment' => $listingcategory->other_equipment,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Golfsimg::where('golf_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Golf::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {
                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'golfs',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),
                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Golf::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,


                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Golf::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Golf::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Golf::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Golf::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Golf::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Golf::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Golf::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Golf::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Golf::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Golf::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Golf::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Golf::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Golf::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Golf::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Golf::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Golf::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'golfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),













                                ],

                        ];



                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;








            case 'huntings':



                        $listingcategory = Hunting::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'bow_arrow' => $listingcategory->bow_arrow,
                                        'crossbow' => $listingcategory->crossbow,
                                        'decoy' => $listingcategory->decoy,
                                        'game_call' => $listingcategory->game_call,
                                        'binoculars' => $listingcategory->binoculars,
                                        'clothing' => $listingcategory->clothing,
                                        'equipment' => $listingcategory->equipment,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Huntingsimg::where('hunting_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Hunting::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'huntings',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),
                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Hunting::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Hunting::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Hunting::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Hunting::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Hunting::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Hunting::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Hunting::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Hunting::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Hunting::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Hunting::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Hunting::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Hunting::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Hunting::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Hunting::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Hunting::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Hunting::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Hunting::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'huntings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),













                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;







            case 'musculations':



                        $listingcategory = Musculation::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'brand_name' => $listingcategory->brand_name,
                                        'arms' => $listingcategory->arms,
                                        'back' => $listingcategory->back,
                                        'shoulders' => $listingcategory->shoulders,
                                        'glutes' => $listingcategory->glutes,
                                        'legs' => $listingcategory->legs,
                                        'chest' => $listingcategory->chest,
                                        'abs' => $listingcategory->abs,
                                        'cardio_machines' => $listingcategory->cardio_machines,
                                        'dumbbells' => $listingcategory->dumbbells,

                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Musculationsimg::where('musculation_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Musculation::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'musculations',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Musculation::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Musculation::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Musculation::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Musculation::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Musculation::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Musculation::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Musculation::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Musculation::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Musculation::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Musculation::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Musculation::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Musculation::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Musculation::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Musculation::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Musculation::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Musculation::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Musculation::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musculations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),















                                ],

                        ];



                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;








            case 'surfs':


                        $listingcategory = Surf::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'surf_category' => $listingcategory->surf_category,
                                        'board_types' => $listingcategory->board_types,
                                        'board_size' => $listingcategory->board_size,
                                        'wetsuits' => $listingcategory->wetsuits,
                                        'surf_other' => $listingcategory->surf_other,
                                        'more_details' => $listingcategory->more_details,

                                    ],



                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Surfsimg::where('surf_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Surf::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'surfs',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Surf::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Surf::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Surf::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Surf::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Surf::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Surf::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Surf::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Surf::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Surf::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Surf::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Surf::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Surf::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Surf::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Surf::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Surf::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Surf::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Surf::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'surfs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),













                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;







            case 'tennis':


                        $listingcategory = Tennis::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'terrain_dimensions' => $listingcategory->terrain_dimensions,
                                        'brand' => $listingcategory->brand,
                                        'clothing' => $listingcategory->clothing,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Tennisimg::where('tennis_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Tennis::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'tennis',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Tennis::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Tennis::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Tennis::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Tennis::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Tennis::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Tennis::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Tennis::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Tennis::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Tennis::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Tennis::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Tennis::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Tennis::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Tennis::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Tennis::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Tennis::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Tennis::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Tennis::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tennis',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;







            case 'audios':


                        $listingcategory = Audio::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'audio_type' => $listingcategory->audio_type,
                                        'sound_quality' => $listingcategory->sound_quality,
                                        'connectivity' => $listingcategory->connectivity,
                                        'max_wireless_range' => $listingcategory->max_wireless_range,
                                        'battery_life' => $listingcategory->battery_life,
                                        'charging_time' => $listingcategory->charging_time,
                                        'condition' => $listingcategory->condition,
                                        'compatibility' => $listingcategory->compatibility,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Audiosimg::where('audio_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Audio::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'audios',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Audio::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Audio::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Audio::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Audio::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Audio::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Audio::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Audio::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Audio::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Audio::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Audio::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Audio::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Audio::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Audio::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Audio::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Audio::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Audio::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Audio::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'audios',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;







            case 'cameras':



                        $listingcategory = Camera::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'photo_size' => $listingcategory->photo_size,
                                        'sensor_size' => $listingcategory->sensor_size,
                                        'image_stabilization' => $listingcategory->image_stabilization,
                                        'shutter_speed' => $listingcategory->shutter_speed,
                                        'exposure_control' => $listingcategory->exposure_control,
                                        'image_resolution' => $listingcategory->image_resolution,
                                        'condition' => $listingcategory->condition,
                                        'connectivity' => $listingcategory->connectivity,
                                        'memory' => $listingcategory->memory,
                                        'lens' => $listingcategory->lens,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Camerasimg::where('camera_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Camera::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'cameras',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Camera::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Camera::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Camera::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Camera::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Camera::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Camera::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Camera::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Camera::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Camera::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Camera::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Camera::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Camera::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Camera::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Camera::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Camera::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Camera::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Camera::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cameras',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),












                                ],

                        ];



                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;






            case 'chargers':



                        $listingcategory = Charger::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'compatibility' => $listingcategory->compatibility,
                                        'number_of_ports' => $listingcategory->number_of_ports,
                                        'length' => $listingcategory->length,
                                        'input_voltage' => $listingcategory->input_voltage,
                                        'wattage' => $listingcategory->wattage,
                                        'condition' => $listingcategory->condition,
                                        'connector_type' => $listingcategory->connector_type,
                                        'amperage' => $listingcategory->amperage,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Chargersimg::where('charger_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Charger::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'chargers',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Charger::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Charger::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Charger::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Charger::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Charger::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Charger::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Charger::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Charger::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Charger::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Charger::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Charger::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Charger::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Charger::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Charger::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Charger::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Charger::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Charger::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'chargers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),













                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;






            case 'drones':



                        $listingcategory = Drone::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'flight_time' => $listingcategory->flight_time,
                                        'battery_life' => $listingcategory->battery_life,
                                        'condition' => $listingcategory->condition,
                                        'video_resolution' => $listingcategory->video_resolution,
                                        'connectivity' => $listingcategory->connectivity,
                                        'battery_capacity' => $listingcategory->battery_capacity,
                                        'memory' => $listingcategory->memory,
                                        'image_resolution' => $listingcategory->image_resolution,
                                        'included_components' => $listingcategory->included_components,
                                        'remote_control' => $listingcategory->remote_control,
                                        'max_distance' => $listingcategory->max_distance,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Dronesimg::where('drone_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Drone::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'drones',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Drone::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Drone::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Drone::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Drone::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Drone::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Drone::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Drone::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Drone::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Drone::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Drone::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Drone::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Drone::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Drone::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Drone::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Drone::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Drone::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Drone::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'drones',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),













                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;









            case 'gamings':



                        $listingcategory = Gaming::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'storage' => $listingcategory->storage,
                                        'connectivity' => $listingcategory->connectivity,
                                        'ports' => $listingcategory->ports,
                                        'online_services' => $listingcategory->online_services,
                                        'condition' => $listingcategory->condition,
                                        'games' => $listingcategory->games,
                                        'controllers' => $listingcategory->controllers,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Gamingsimg::where('gaming_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Gaming::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'gamings',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Gaming::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Gaming::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Gaming::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Gaming::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Gaming::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Gaming::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Gaming::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Gaming::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Gaming::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Gaming::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Gaming::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Gaming::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Gaming::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Gaming::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Gaming::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Gaming::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Gaming::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'gamings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;







            case 'laptops':






                        $listingcategory = Laptop::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'ram' => $listingcategory->ram,
                                        'graphics_card' => $listingcategory->graphics_card,
                                        'operating_system' => $listingcategory->operating_system,
                                        'number_ports' => $listingcategory->number_ports,
                                        'battery_life' => $listingcategory->battery_life,
                                        'drive_storage' => $listingcategory->drive_storage,
                                        'resolution' => $listingcategory->resolution,
                                        'weight' => $listingcategory->weight,
                                        'screen_size' => $listingcategory->screen_size,
                                        'cpu' => $listingcategory->cpu,
                                        'condition' => $listingcategory->condition,
                                        'more_details' => $listingcategory->more_details,

                                    ],



                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Laptopsimg::where('laptop_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Laptop::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'laptops',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Laptop::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Laptop::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Laptop::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Laptop::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Laptop::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Laptop::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Laptop::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Laptop::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Laptop::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Laptop::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Laptop::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Laptop::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Laptop::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Laptop::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Laptop::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Laptop::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Laptop::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'laptops',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),









                                ],

                        ];




                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);








                break;








            case 'lightings':



                        $listingcategory = Lighting::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'connectivity' => $listingcategory->connectivity,
                                        'included_accessories' => $listingcategory->included_accessories,
                                        'condition' => $listingcategory->condition,
                                        'color_temperature' => $listingcategory->color_temperature,
                                        'compatibility' => $listingcategory->compatibility,
                                        'more_details' => $listingcategory->more_details,

                                    ],

                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Lightingsimg::where('lighting_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Lighting::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'lightings',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Lighting::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Lighting::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Lighting::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Lighting::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Lighting::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Lighting::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Lighting::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Lighting::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Lighting::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Lighting::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Lighting::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Lighting::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Lighting::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Lighting::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Lighting::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Lighting::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Lighting::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'lightings',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;








            case 'printers':



                        $listingcategory = Printer::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'print_speed' => $listingcategory->print_speed,
                                        'print_resolution' => $listingcategory->print_resolution,
                                        'connectivity' => $listingcategory->connectivity,
                                        'paper_size' => $listingcategory->paper_size,
                                        'compatible' => $listingcategory->compatible,
                                        'condition' => $listingcategory->condition,
                                        'input_sheets' => $listingcategory->input_sheets,
                                        'print_media' => $listingcategory->print_media,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Printersimg::where('printer_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Printer::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'printers',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Printer::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Printer::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Printer::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Printer::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Printer::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Printer::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Printer::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Printer::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Printer::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Printer::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Printer::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Printer::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Printer::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Printer::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Printer::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Printer::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Printer::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'printers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),












                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'routers':


                        $listingcategory = Router::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'gbps_speed' => $listingcategory->gbps_speed,
                                        'wireless' => $listingcategory->wireless,
                                        'frequency' => $listingcategory->frequency,
                                        'connectivity' => $listingcategory->connectivity,
                                        'antennas' => $listingcategory->antennas,
                                        'condition' => $listingcategory->condition,
                                        'compatible' => $listingcategory->compatible,
                                        'signal_coverage' => $listingcategory->signal_coverage,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Routersimg::where('router_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Router::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'routers',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Router::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Router::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Router::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Router::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Router::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Router::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Router::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Router::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Router::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Router::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Router::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Router::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Router::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Router::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Router::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Router::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Router::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'routers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;







            case 'tablettes':


                        $listingcategory = Tablette::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'operating_system' => $listingcategory->operating_system,
                                        'ram' => $listingcategory->ram,
                                        'storage' => $listingcategory->storage,
                                        'display_size' => $listingcategory->display_size,
                                        'display_resolution' => $listingcategory->display_resolution,
                                        'connectivity' => $listingcategory->connectivity,
                                        'condition' => $listingcategory->condition,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Tablettesimg::where('tablette_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Tablette::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {
                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'tablettes',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Tablette::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Tablette::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Tablette::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Tablette::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Tablette::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Tablette::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Tablette::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Tablette::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Tablette::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Tablette::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Tablette::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Tablette::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Tablette::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Tablette::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Tablette::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Tablette::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Tablette::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tablettes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;







            case 'eclairages':


                        $listingcategory = Eclairage::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'brand_name' => $listingcategory->brand_name,
                                        'size' => $listingcategory->size,
                                        'voltage' => $listingcategory->voltage,
                                        'chandeliers' => $listingcategory->chandeliers,
                                        'lamps' => $listingcategory->lamps,
                                        'light_fixtures' => $listingcategory->light_fixtures,
                                        'projectors' => $listingcategory->projectors,
                                        'leds' => $listingcategory->leds,
                                        'power_source' => $listingcategory->power_source,
                                        'light_source' => $listingcategory->light_source,
                                        'light_color' => $listingcategory->light_color,
                                        'lighting_method' => $listingcategory->lighting_method,
                                        'controller' => $listingcategory->controller,
                                        'other' => $listingcategory->other,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Eclairagesimg::where('eclairage_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Eclairage::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'eclairages',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Eclairage::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Eclairage::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Eclairage::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Eclairage::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Eclairage::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Eclairage::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Eclairage::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Eclairage::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Eclairage::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Eclairage::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Eclairage::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Eclairage::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Eclairage::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Eclairage::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Eclairage::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Eclairage::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {



                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Eclairage::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'eclairages',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;







            case 'mobiliers':



                        $listingcategory = Mobilier::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'material' => $listingcategory->material,
                                        'theme' => $listingcategory->theme,
                                        'plant_decorations' => $listingcategory->plant_decorations,
                                        'light_decorations' => $listingcategory->light_decorations,
                                        'festive_decorations' => $listingcategory->festive_decorations,
                                        'others' => $listingcategory->others,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Mobiliersimg::where('mobilier_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Mobilier::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [


                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'mobiliers',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Mobilier::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Mobilier::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Mobilier::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Mobilier::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Mobilier::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Mobilier::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Mobilier::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Mobilier::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Mobilier::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Mobilier::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Mobilier::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Mobilier::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Mobilier::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Mobilier::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Mobilier::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentListingseljadida' => Mobilier::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Mobilier::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mobiliers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),









                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;







            case 'photographies':



                        $listingcategory = Photographie::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'size' => $listingcategory->size,
                                        'battery' => $listingcategory->battery,
                                        'brand_name' => $listingcategory->brand_name,
                                        'camera' => $listingcategory->camera,
                                        'sensor' => $listingcategory->sensor,
                                        'angle' => $listingcategory->angle,
                                        'lcd' => $listingcategory->lcd,
                                        'other_equipment' => $listingcategory->other_equipment,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Photographiesimg::where('photographie_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Photographie::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'photographies',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Photographie::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Photographie::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Photographie::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Photographie::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Photographie::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Photographie::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Photographie::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Photographie::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Photographie::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Photographie::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Photographie::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Photographie::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Photographie::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Photographie::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Photographie::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Photographie::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Photographie::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'photographies',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'sonorisations':


                $listingcategory = Sonorisation::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'brand_name' => $listingcategory->brand_name,
                                        'size' => $listingcategory->size,
                                        'connectivity' => $listingcategory->connectivity,
                                        'fastener_type' => $listingcategory->fastener_type,
                                        'power_source' => $listingcategory->power_source,
                                        'output_power' => $listingcategory->output_power,
                                        'number_of_channels' => $listingcategory->number_of_channels,
                                        'compatibility' => $listingcategory->compatibility,
                                        'power_watts' => $listingcategory->power_watts,
                                        'power_type' => $listingcategory->power_type,
                                        'battery' => $listingcategory->battery,
                                        'weight' => $listingcategory->weight,
                                        'microphone' => $listingcategory->microphone,
                                        'mixage_table' => $listingcategory->mixage_table,
                                        'amplifier' => $listingcategory->amplifier,
                                        'cables_connectors' => $listingcategory->cables_connectors,
                                        'speaker' => $listingcategory->speaker,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Sonorisationsimg::where('sonorisation_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Sonorisation::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'sonorisations',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Sonorisation::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Sonorisation::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Sonorisation::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Sonorisation::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Sonorisation::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Sonorisation::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Sonorisation::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Sonorisation::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Sonorisation::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Sonorisation::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Sonorisation::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Sonorisation::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Sonorisation::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Sonorisation::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Sonorisation::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Sonorisation::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Sonorisation::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'sonorisations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;







            case 'tentes':



                        $listingcategory = Tente::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'material' => $listingcategory->material,
                                        'style' => $listingcategory->style,
                                        'fabric_type' => $listingcategory->fabric_type,
                                        'other_equipment' => $listingcategory->other_equipment,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Tentesimg::where('tente_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Tente::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [


                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'tentes',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Tente::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Tente::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Tente::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Tente::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Tente::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Tente::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Tente::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Tente::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Tente::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Tente::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Tente::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Tente::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Tente::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Tente::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Tente::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Tente::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Tente::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'tentes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'clothes':



                        $listingcategory = Clothes::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'number_of_pieces' => $listingcategory->number_of_pieces,
                                        'closure_type' => $listingcategory->closure_type,
                                        'strap_type' => $listingcategory->strap_type,
                                        'number_of_pockets' => $listingcategory->number_of_pockets,
                                        'heel_height' => $listingcategory->heel_height,
                                        'condition' => $listingcategory->condition,
                                        'color' => $listingcategory->color,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Clothesimg::where('clothes_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Clothes::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'clothes',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Clothes::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Clothes::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Clothes::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Clothes::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Clothes::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Clothes::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Clothes::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Clothes::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Clothes::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Clothes::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Clothes::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Clothes::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Clothes::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Clothes::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Clothes::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Clothes::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Clothes::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'clothes',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;







            case 'jewelrys':


                        $listingcategory = Jewelry::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();


                        $userStore = Onlinestore::where('user_id', $user->id)->first();

                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'type' => $listingcategory->type,
                                        'materials' => $listingcategory->materials,
                                        'occasion' => $listingcategory->occasion,
                                        'chain_type' => $listingcategory->chain_type,
                                        'gem_type' => $listingcategory->gem_type,
                                        'color' => $listingcategory->color,
                                        'closure_type' => $listingcategory->closure_type,
                                        'condition' => $listingcategory->condition,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Jewelrysimg::where('jewelry_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Jewelry::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [


                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'jewelrys',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Jewelry::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Jewelry::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Jewelry::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Jewelry::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Jewelry::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Jewelry::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Jewelry::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Jewelry::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Jewelry::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Jewelry::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Jewelry::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Jewelry::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Jewelry::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Jewelry::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                    $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                    $totalReviews = $reviews->count();
                                    $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Jewelry::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Jewelry::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Jewelry::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'jewelrys',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;






            case 'apartments':



                        $listingcategory = Apartment::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'rooms' => $listingcategory->rooms,
                                        'living_rooms' => $listingcategory->living_rooms,
                                        'bathrooms' => $listingcategory->bathrooms,
                                        'bedrooms' => $listingcategory->bedrooms,
                                        'security_system' => $listingcategory->security_system,
                                        'equipped_kitchen' => $listingcategory->equipped_kitchen,
                                        'service' => $listingcategory->service,
                                        'facilities' => $listingcategory->facilities,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Apartmentsimg::where('apartment_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Apartment::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'apartments',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Apartment::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Apartment::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Apartment::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Apartment::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Apartment::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Apartment::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Apartment::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Apartment::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Apartment::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Apartment::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Apartment::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Apartment::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Apartment::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Apartment::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Apartment::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Apartment::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Apartment::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'apartments',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;







            case 'bureauxs':




                        $listingcategory = Bureaux::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'property_type' => $listingcategory->property_type,
                                        'security' => $listingcategory->security,
                                        'soil_type' => $listingcategory->soil_type,
                                        'parking' => $listingcategory->parking,
                                        'bathrooms' => $listingcategory->bathrooms,
                                        'conference_room' => $listingcategory->conference_room,
                                        'building_size' => $listingcategory->building_size,
                                        'lighting' => $listingcategory->lighting,
                                        'capacity' => $listingcategory->capacity,
                                        'bail_type' => $listingcategory->bail_type,
                                        'security_deposit' => $listingcategory->security_deposit,
                                        'office_taxes' => $listingcategory->office_taxes,
                                        'facilities' => $listingcategory->facilities,
                                        'amenities' => $listingcategory->amenities,
                                        'services' => $listingcategory->services,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Bureauxsimg::where('bureaux_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Bureaux::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [


                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'bureauxs',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Bureaux::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Bureaux::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Bureaux::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Bureaux::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Bureaux::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Bureaux::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Bureaux::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Bureaux::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Bureaux::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Bureaux::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Bureaux::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Bureaux::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Bureaux::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Bureaux::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Bureaux::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Bureaux::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Bureaux::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'bureauxs',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'magasins':



                        $listingcategory = Magasin::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'property_type' => $listingcategory->property_type,
                                        'surface_area' => $listingcategory->surface_area,
                                        'capacity' => $listingcategory->capacity,
                                        'offices_number' => $listingcategory->offices_number,
                                        'individual_offices' => $listingcategory->individual_offices,
                                        'floors' => $listingcategory->floors,
                                        'garage' => $listingcategory->garage,
                                        'approved_uses' => $listingcategory->approved_uses,
                                        'facility_size' => $listingcategory->facility_size,
                                        'operating_days' => $listingcategory->operating_days,
                                        'lighting' => $listingcategory->lighting,
                                        'transports' => $listingcategory->transports,
                                        'facilities' => $listingcategory->facilities,
                                        'amenities' => $listingcategory->amenities,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Magasinsimg::where('magasin_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Magasin::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [


                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'magasins',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Magasin::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Magasin::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Magasin::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Magasin::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Magasin::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Magasin::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Magasin::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Magasin::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Magasin::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Magasin::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Magasin::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Magasin::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Magasin::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Magasin::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Magasin::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Magasin::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Magasin::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'magasins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'maisons':


                        $listingcategory = Maison::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();


                        $userStore = Onlinestore::where('user_id', $user->id)->first();

                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'security_system' => $listingcategory->security_system,
                                        'rooms' => $listingcategory->rooms,
                                        'living_rooms' => $listingcategory->living_rooms,
                                        'bedrooms' => $listingcategory->bedrooms,
                                        'bathrooms' => $listingcategory->bathrooms,
                                        'floors' => $listingcategory->floors,
                                        'amenities' => $listingcategory->amenities,
                                        'facilities' => $listingcategory->facilities,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Maisonsimg::where('maison_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Maison::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'maisons',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Maison::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Maison::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Maison::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Maison::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Maison::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Maison::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Maison::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Maison::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Maison::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Maison::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Maison::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Maison::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Maison::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Maison::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Maison::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Maison::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Maison::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'maisons',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),









                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;






            case 'riads':




                        $listingcategory = Riad::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();


                        $userStore = Onlinestore::where('user_id', $user->id)->first();

                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,



                                    'specifications' => [
                                        'entire_home' => $listingcategory->entire_home,
                                        'doorkeeper' => $listingcategory->doorkeeper,
                                        'security_system' => $listingcategory->security_system,
                                        'equipped_kitchen' => $listingcategory->equipped_kitchen,
                                        'wifi' => $listingcategory->wifi,
                                        'tv' => $listingcategory->tv,
                                        'heating' => $listingcategory->heating,
                                        'furniture' => $listingcategory->furniture,
                                        'balcony' => $listingcategory->balcony,
                                        'air_conditioner' => $listingcategory->air_conditioner,
                                        'washing_machine' => $listingcategory->washing_machine,
                                        'pool' => $listingcategory->pool,
                                        'rooms' => $listingcategory->rooms,
                                        'living_rooms' => $listingcategory->living_rooms,
                                        'surface' => $listingcategory->surface,
                                        'floors' => $listingcategory->floors,
                                        'year_construction' => $listingcategory->year_construction,
                                        'bedrooms' => $listingcategory->bedrooms,
                                        'bathrooms' => $listingcategory->bathrooms,
                                        'garden' => $listingcategory->garden,
                                        'terrace' => $listingcategory->terrace,
                                        'housekeeping' => $listingcategory->housekeeping,
                                        'dishwasher' => $listingcategory->dishwasher,
                                        'barbecue' => $listingcategory->barbecue,
                                        'refrigerator' => $listingcategory->refrigerator,
                                        'microwave' => $listingcategory->microwave,
                                        'outdoor_furniture' => $listingcategory->outdoor_furniture,
                                        'private_entrance' => $listingcategory->private_entrance,
                                        'hammam' => $listingcategory->hammam,
                                        'jacuzzi' => $listingcategory->jacuzzi,
                                        'gym' => $listingcategory->gym,
                                        'architecture' => $listingcategory->architecture,
                                        'view' => $listingcategory->view,
                                        'restaurant' => $listingcategory->restaurant,
                                        'spa' => $listingcategory->spa,
                                        'airport' => $listingcategory->airport,
                                        'smoking_rooms' => $listingcategory->smoking_rooms,
                                        'more_details' => $listingcategory->more_details,

                                    ],





                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Riadsimg::where('riad_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Riad::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [


                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'riads',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Riad::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Riad::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Riad::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Riad::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Riad::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Riad::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Riad::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Riad::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Riad::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Riad::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Riad::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Riad::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Riad::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Riad::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Riad::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Riad::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Riad::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'riads',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;





            case 'terrains':




                        $listingcategory = Terrain::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();


                        $userStore = Onlinestore::where('user_id', $user->id)->first();

                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'property_type' => $listingcategory->property_type,
                                        'property_subtype' => $listingcategory->property_subtype,
                                        'total_lot_size' => $listingcategory->total_lot_size,
                                        'land_valuation' => $listingcategory->land_valuation,
                                        'total_rating' => $listingcategory->total_rating,
                                        'road_access' => $listingcategory->road_access,
                                        'slope_description' => $listingcategory->slope_description,
                                        'property_usage' => $listingcategory->property_usage,
                                        'annual_taxes' => $listingcategory->annual_taxes,
                                        'deeded_acres' => $listingcategory->deeded_acres,
                                        'leased_acres' => $listingcategory->leased_acres,
                                        'elevation' => $listingcategory->elevation,
                                        'vegetation' => $listingcategory->vegetation,
                                        'nearby_usage' => $listingcategory->nearby_usage,
                                        'topography' => $listingcategory->topography,
                                        'zoning' => $listingcategory->zoning,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Terrainsimg::where('terrain_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Terrain::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [


                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'terrains',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Terrain::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Terrain::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Terrain::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Terrain::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Terrain::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Terrain::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Terrain::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Terrain::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Terrain::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Terrain::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Terrain::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Terrain::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Terrain::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Terrain::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Terrain::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Terrain::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Terrain::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'terrains',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);


                break;







            case 'villas':



                        $listingcategory = Villa::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'rooms' => $listingcategory->rooms,
                                        'living_rooms' => $listingcategory->living_rooms,
                                        'bedrooms' => $listingcategory->bedrooms,
                                        'bathrooms' => $listingcategory->bathrooms,
                                        'view' => $listingcategory->view,
                                        'security_system' => $listingcategory->security_system,
                                        'facilities' => $listingcategory->facilities,
                                        'amenities' => $listingcategory->amenities,
                                        'services' => $listingcategory->services,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Villasimg::where('villa_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Villa::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'villas',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Villa::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Villa::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Villa::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Villa::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Villa::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Villa::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Villa::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Villa::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Villa::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Villa::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Villa::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Villa::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Villa::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Villa::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Villa::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews




                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Villa::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Villa::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'villas',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'activities':


                        $listingcategory = Activity::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'type' => $listingcategory->type,
                                        'equipment' => $listingcategory->equipment,
                                        'age_requirement' => $listingcategory->age_requirement,
                                        'duration' => $listingcategory->duration,
                                        'language' => $listingcategory->language,
                                        'cancellation' => $listingcategory->cancellation,
                                        'safety_equipment' => $listingcategory->safety_equipment,
                                        'monitor' => $listingcategory->monitor,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Activitiesimg::where('activity_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Activity::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'activities',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Activity::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Activity::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Activity::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Activity::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Activity::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Activity::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Activity::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Activity::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Activity::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Activity::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Activity::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Activity::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Activity::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Activity::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Activity::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Activity::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Activity::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'activities',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),













                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;






            case 'livres':


                        $listingcategory = Livre::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'genre' => $listingcategory->genre,
                                        'type' => $listingcategory->type,
                                        'language' => $listingcategory->language,
                                        'format' => $listingcategory->format,
                                        'duration' => $listingcategory->duration,
                                        'more_details' => $listingcategory->more_details,

                                    ],



                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Livresimg::where('livre_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Livre::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'livres',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Livre::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Livre::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Livre::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Livre::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Livre::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Livre::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Livre::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Livre::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Livre::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Livre::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Livre::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Livre::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Livre::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Livre::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Livre::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Livre::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Livre::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'livres',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'musicals':




                        $listingcategory = Musical::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'music_type' => $listingcategory->music_type,
                                        'material' => $listingcategory->material,
                                        'style' => $listingcategory->style,
                                        'finish_type' => $listingcategory->finish_type,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Musicalsimg::where('musical_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Musical::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'musicals',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Musical::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Musical::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Musical::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Musical::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Musical::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Musical::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Musical::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Musical::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Musical::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Musical::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Musical::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Musical::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Musical::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Musical::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Musical::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Musical::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Musical::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'musicals',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),









                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'furnitures':


                        $listingcategory = Furniture::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'furniture_type' => $listingcategory->furniture_type,
                                        'material' => $listingcategory->material,
                                        'shape' => $listingcategory->shape,
                                        'cushion_thickness' => $listingcategory->cushion_thickness,
                                        'capacity' => $listingcategory->capacity,
                                        'fill_material' => $listingcategory->fill_material,
                                        'condition' => $listingcategory->condition,
                                        'color' => $listingcategory->color,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Furnituresimg::where('furniture_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Furniture::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'furnitures',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Furniture::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Furniture::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Furniture::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Furniture::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Furniture::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Furniture::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Furniture::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Furniture::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Furniture::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Furniture::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Furniture::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Furniture::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Furniture::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Furniture::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Furniture::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Furniture::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Furniture::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'furnitures',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;






            case 'houseappliances':

                        $listingcategory = Houseappliance::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'access_location' => $listingcategory->access_location,
                                        'finish_type' => $listingcategory->finish_type,
                                        'cycle_options' => $listingcategory->cycle_options,
                                        'inlet_water' => $listingcategory->inlet_water,
                                        'installation_method' => $listingcategory->installation_method,
                                        'components' => $listingcategory->components,
                                        'control_type' => $listingcategory->control_type,
                                        'certification' => $listingcategory->certification,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Houseappliancesimg::where('houseappliance_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place











                                    'recentlistings' => Houseappliance::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'houseappliances',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Houseappliance::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Houseappliance::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Houseappliance::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Houseappliance::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Houseappliance::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Houseappliance::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Houseappliance::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Houseappliance::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Houseappliance::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Houseappliance::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Houseappliance::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Houseappliance::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Houseappliance::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Houseappliance::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Houseappliance::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Houseappliance::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Houseappliance::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'houseappliances',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);


                break;






            case 'electricaltools':




                        $listingcategory = Electricaltool::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'tool_type' => $listingcategory->tool_type,
                                        'condition' => $listingcategory->condition,
                                        'voltage' => $listingcategory->voltage,
                                        'amperage' => $listingcategory->amperage,
                                        'cord_length' => $listingcategory->cord_length,
                                        'battery_life' => $listingcategory->battery_life,
                                        'display' => $listingcategory->display,
                                        'frequency' => $listingcategory->frequency,
                                        'temperature' => $listingcategory->temperature,
                                        'voltage_sensing_ranges' => $listingcategory->voltage_sensing_ranges,
                                        'detector' => $listingcategory->detector,
                                        'operating_altitude' => $listingcategory->operating_altitude,
                                        'compatible' => $listingcategory->compatible,
                                        'bending_angle' => $listingcategory->bending_angle,
                                        'accessories' => $listingcategory->accessories,
                                        'style' => $listingcategory->style,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Electricaltoolsimg::where('Electricaltool_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Electricaltool::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'electricaltools',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Electricaltool::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Electricaltool::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Electricaltool::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Electricaltool::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Electricaltool::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Electricaltool::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Electricaltool::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Electricaltool::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Electricaltool::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Electricaltool::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Electricaltool::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Electricaltool::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Electricaltool::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Electricaltool::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Electricaltool::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Electricaltool::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Electricaltool::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'electricaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;






            case 'ladders':



                        $listingcategory = Ladder::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'tool_type' => $listingcategory->tool_type,
                                        'condition' => $listingcategory->condition,
                                        'power_source' => $listingcategory->power_source,
                                        'material' => $listingcategory->material,
                                        'height' => $listingcategory->height,
                                        'weight' => $listingcategory->weight,
                                        'number_of_steps' => $listingcategory->number_of_steps,
                                        'load_capacity' => $listingcategory->load_capacity,
                                        'battery_life' => $listingcategory->battery_life,
                                        'style' => $listingcategory->style,
                                        'wheel_size' => $listingcategory->wheel_size,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Laddersimg::where('ladder_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Ladder::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'ladders',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Ladder::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Ladder::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Ladder::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Ladder::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Ladder::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Ladder::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Ladder::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Ladder::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Ladder::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Ladder::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Ladder::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Ladder::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Ladder::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Ladder::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Ladder::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Ladder::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Ladder::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'ladders',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);


                break;






            case 'mechanicaltools':



                        $listingcategory = Mechanicaltool::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'tool_type' => $listingcategory->tool_type,
                                        'condition' => $listingcategory->condition,
                                        'power_source' => $listingcategory->power_source,
                                        'voltage' => $listingcategory->voltage,
                                        'battery_life' => $listingcategory->battery_life,
                                        'blade_diameter' => $listingcategory->blade_diameter,
                                        'material' => $listingcategory->material,
                                        'style' => $listingcategory->style,
                                        'cutting_width' => $listingcategory->cutting_width,
                                        'carburetor_type' => $listingcategory->carburetor_type,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Mechanicaltoolsimg::where('mechanicaltool_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Mechanicaltool::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'mechanicaltools',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,


                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Mechanicaltool::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Mechanicaltool::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Mechanicaltool::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Mechanicaltool::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Mechanicaltool::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Mechanicaltool::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Mechanicaltool::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Mechanicaltool::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Mechanicaltool::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Mechanicaltool::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Mechanicaltool::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Mechanicaltool::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Mechanicaltool::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Mechanicaltool::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Mechanicaltool::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Mechanicaltool::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Mechanicaltool::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'mechanicaltools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;





            case 'powertools':



                        $listingcategory = Powertool::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();


                        $userStore = Onlinestore::where('user_id', $user->id)->first();

                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'tool_type' => $listingcategory->tool_type,
                                        'condition' => $listingcategory->condition,
                                        'power_source' => $listingcategory->power_source,
                                        'voltage' => $listingcategory->voltage,
                                        'battery_life' => $listingcategory->battery_life,
                                        'material' => $listingcategory->material,
                                        'noise_level' => $listingcategory->noise_level,
                                        'grit_number' => $listingcategory->grit_number,
                                        'rotational_speed' => $listingcategory->rotational_speed,
                                        'blade_material' => $listingcategory->blade_material,
                                        'surface' => $listingcategory->surface,
                                        'style' => $listingcategory->style,
                                        'amperage' => $listingcategory->amperage,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Powertoolsimg::where('powertool_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Powertool::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'powertools',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Powertool::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Powertool::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Powertool::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Powertool::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Powertool::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Powertool::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Powertool::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Powertool::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Powertool::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Powertool::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Powertool::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Powertool::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Powertool::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Powertool::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Powertool::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Powertool::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Powertool::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'powertools',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),












                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'pressurewashers':



                        $listingcategory = Pressurewasher::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'tool_type' => $listingcategory->tool_type,
                                        'condition' => $listingcategory->condition,
                                        'power_source' => $listingcategory->power_source,
                                        'power_output' => $listingcategory->power_output,
                                        'engine_power' => $listingcategory->engine_power,
                                        'hose_length' => $listingcategory->hose_length,
                                        'cord_length' => $listingcategory->cord_length,
                                        'weight' => $listingcategory->weight,
                                        'maximum_flow_rate' => $listingcategory->maximum_flow_rate,
                                        'specification_met' => $listingcategory->specification_met,
                                        'inlet_connection_type' => $listingcategory->inlet_connection_type,
                                        'outlet_connection_size' => $listingcategory->outlet_connection_size,
                                        'max_working_temperature' => $listingcategory->max_working_temperature,
                                        'connection_type' => $listingcategory->connection_type,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Pressurewashersimg::where('pressurewasher_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Pressurewasher::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'pressurewashers',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Pressurewasher::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Pressurewasher::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Pressurewasher::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Pressurewasher::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Pressurewasher::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Pressurewasher::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Pressurewasher::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Pressurewasher::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Pressurewasher::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Pressurewasher::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Pressurewasher::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Pressurewasher::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Pressurewasher::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Pressurewasher::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Pressurewasher::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Pressurewasher::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Pressurewasher::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'pressurewashers',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'services':



                        $listingcategory = Service::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'languages' => $listingcategory->languages,
                                        'experience' => $listingcategory->experience,
                                        'response_time' => $listingcategory->response_time,
                                        'package' => $listingcategory->package,
                                        'revisions' => $listingcategory->revisions,
                                        'level' => $listingcategory->level,
                                        'orders_queue' => $listingcategory->orders_queue,
                                        'jobs_completed' => $listingcategory->jobs_completed,
                                        'repeat_hire_rate' => $listingcategory->repeat_hire_rate,
                                        'education' => $listingcategory->education,
                                        'on_time' => $listingcategory->on_time,
                                        'delivery_time' => $listingcategory->delivery_time,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Servicesimg::where('service_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Service::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'services',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Service::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Service::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Service::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Service::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Service::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Service::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Service::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Service::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Service::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Service::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Service::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Service::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Service::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Service::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Service::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Service::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Service::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'services',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'boats':


                        $listingcategory = Boat::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'boat_type' => $listingcategory->boat_type,
                                        'capacity' => $listingcategory->capacity,
                                        'cabins' => $listingcategory->cabins,
                                        'berths_in_cabin' => $listingcategory->berths_in_cabin,
                                        'cruising_time' => $listingcategory->cruising_time,
                                        'length' => $listingcategory->length,
                                        'security' => $listingcategory->security,
                                        'navigation' => $listingcategory->navigation,
                                        'kitchen_equipment' => $listingcategory->kitchen_equipment,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Boatsimg::where('boat_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Boat::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'boats',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Boat::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Boat::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Boat::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Boat::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Boat::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Boat::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Boat::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Boat::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Boat::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Boat::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Boat::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Boat::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Boat::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Boat::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Boat::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Boat::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Boat::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'boats',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;






            case 'camions':


                        $listingcategory = Camion::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();


                        $userStore = Onlinestore::where('user_id', $user->id)->first();

                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'type' => $listingcategory->type,
                                        'fuel_type' => $listingcategory->fuel_type,
                                        'condition' => $listingcategory->condition,
                                        'transmission' => $listingcategory->transmission,
                                        'insurance' => $listingcategory->insurance,
                                        'navigation_system' => $listingcategory->navigation_system,

                                        'more_details' => $listingcategory->more_details,

                                        // Add more specifications as needed
                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Camionsimg::where('camion_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Camion::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'camions',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Camion::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Camion::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Camion::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Camion::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Camion::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Camion::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Camion::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Camion::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Camion::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Camion::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Camion::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Camion::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Camion::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Camion::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Camion::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Camion::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Camion::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'camions',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),












                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;





            case 'caravans':


                        $listingcategory = Caravan::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'gearbox' => $listingcategory->gearbox,
                                        'fuel_type' => $listingcategory->fuel_type,
                                        'kitchen_equipment' => $listingcategory->kitchen_equipment,
                                        'toilet' => $listingcategory->toilet,
                                        'furniture' => $listingcategory->furniture,
                                        'accessories' => $listingcategory->accessories,
                                        'more_details' => $listingcategory->more_details,

                                        // Add more specifications as needed
                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Caravansimg::where('caravan_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Caravan::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'caravans',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Caravan::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Caravan::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Caravan::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Caravan::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Caravan::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Caravan::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Caravan::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Caravan::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Caravan::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Caravan::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Caravan::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Caravan::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Caravan::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Caravan::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Caravan::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Caravan::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Caravan::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'caravans',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);



                break;





            case 'cars':


                        $listingcategory = Car::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'transmission' => $listingcategory->transmission,
                                        'fuel_type' => $listingcategory->fuel_type,
                                        'number_of_doors' => $listingcategory->number_of_doors,
                                        'condition' => $listingcategory->condition,
                                        'more_details' => $listingcategory->more_details,
                                        'seats' => $listingcategory->seats,
                                        'more_details' => $listingcategory->more_details,


                                        // Add more specifications as needed
                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Carsimg::where('car_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Car::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'cars',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Car::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Car::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Car::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Car::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Car::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Car::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Car::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Car::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Car::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Car::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Car::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Car::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Car::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Car::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Car::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Car::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Car::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'cars',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;





            case 'engins':



                        $listingcategory = Engin::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,


                                    'specifications' => [
                                        'type' => $listingcategory->type,
                                        'mechanical_condition' => $listingcategory->mechanical_condition,
                                        'transmission' => $listingcategory->transmission,
                                        'cab' => $listingcategory->cab,
                                        'cab_condition' => $listingcategory->cab_condition,
                                        'coupler' => $listingcategory->coupler,
                                        'hydraulics' => $listingcategory->hydraulics,
                                        'seats' => $listingcategory->seats,
                                        'more_details' => $listingcategory->more_details,

                                        // Add more specifications as needed
                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Enginsimg::where('engin_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Engin::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'engins',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Engin::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Engin::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Engin::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Engin::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Engin::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Engin::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Engin::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Engin::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Engin::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Engin::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Engin::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Engin::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Engin::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Engin::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Engin::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Engin::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Engin::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'engins',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;





            case 'motos':


                        $listingcategory = Moto::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'condition' => $listingcategory->condition,
                                        'gearbox' => $listingcategory->gearbox,
                                        'insurance' => $listingcategory->insurance,
                                        'power' => $listingcategory->power,
                                        'speed' => $listingcategory->speed,
                                        'toolkit' => $listingcategory->toolkit,
                                        'intercom' => $listingcategory->intercom,
                                        'more_details' => $listingcategory->more_details,


                                        // Add more specifications as needed
                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Motosimg::where('moto_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Moto::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'motos',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Moto::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews



                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Moto::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Moto::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Moto::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Moto::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Moto::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Moto::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Moto::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Moto::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Moto::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Moto::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Moto::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Moto::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Moto::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Moto::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Moto::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Moto::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'motos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);





                break;





            case 'scooters':


                        $listingcategory = Scooter::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'condition' => $listingcategory->condition,
                                        'more_details' => $listingcategory->more_details,

                                    ],



                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Scootersimg::where('scooter_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Scooter::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'scooters',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Scooter::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Scooter::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Scooter::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Scooter::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Scooter::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Scooter::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Scooter::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Scooter::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Scooter::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Scooter::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Scooter::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Scooter::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Scooter::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Scooter::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Scooter::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Scooter::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Scooter::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'scooters',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;






            case 'taxiaeroports':



                        $listingcategory = Taxiaeroport::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'passengers' => $listingcategory->passengers,
                                        'luggage' => $listingcategory->luggage,
                                        'storage' => $listingcategory->storage,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Taxiaeroportsimg::where('taxiaeroport_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place










                                    'recentlistings' => Taxiaeroport::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'taxiaeroports',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),


                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Taxiaeroport::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Taxiaeroport::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Taxiaeroport::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Taxiaeroport::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Taxiaeroport::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Taxiaeroport::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {
                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Taxiaeroport::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Taxiaeroport::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Taxiaeroport::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Taxiaeroport::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Taxiaeroport::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Taxiaeroport::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Taxiaeroport::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Taxiaeroport::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Taxiaeroport::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Taxiaeroport::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Taxiaeroport::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'taxiaeroports',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);






                break;





            case 'transportations':



                        $listingcategory = Transportation::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,

                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,

                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'passengers' => $listingcategory->passengers,
                                        'luggage' => $listingcategory->luggage,
                                        'condition' => $listingcategory->condition,
                                        'duration' => $listingcategory->duration,
                                        'gearbox' => $listingcategory->gearbox,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Transportationsimg::where('transportation_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place








                                    'recentlistings' => Transportation::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,

                                                'averageRating' => $averageRating,
                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'transportations',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Transportation::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {


                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Transportation::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Transportation::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Transportation::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Transportation::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Transportation::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Transportation::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Transportation::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Transportation::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Transportation::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Transportation::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Transportation::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Transportation::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Transportation::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Transportation::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Transportation::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Transportation::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'transportations',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),










                                ],

                        ];

                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);




                break;







            case 'velos':



                        $listingcategory = Velo::where('url', $url)->first();
                        $reservations = $listingcategory->reservation()->orderBy('reservationstart')->get();
                        $reviewslistings = $listingcategory->review()->orderBy('created_at')->get();
                        $user = User::where('id', $listingcategory->user_id)->first();

                        $userStore = Onlinestore::where('user_id', $user->id)->first();


                        // Calculate total reviews and average rating
                        $totalReviews = $reviewslistings->count();
                        $averageRating = $totalReviews > 0 ? $reviewslistings->avg('rating') : 0;



                        $listingsData = [

                                'type' => $category,
                                'id' => $listingcategory->id,
                                'attributes' => [
                                    'title' => $listingcategory->title,
                                    'price' => $listingcategory->price,
                                    'description' => $listingcategory->description,
                                    'startdate' => $listingcategory->startdate,
                                    'enddate' => $listingcategory->enddate,
                                    'address' => $listingcategory->address,
                                    'city' => $listingcategory->city,
                                    'phone' => $listingcategory->phone,
                                    'id' => $listingcategory->id,


                                    'picture' => $listingcategory->picture,





                                    'country' => $listingcategory->country,
                                    'zip' => $listingcategory->zip,
                                    'category' => $category,
                                    'url' => $url,

                                    'specifications' => [
                                        'bike_type' => $listingcategory->bike_type,
                                        'seatpost' => $listingcategory->seatpost,
                                        'condition' => $listingcategory->condition,
                                        'storage' => $listingcategory->storage,
                                        'fork' => $listingcategory->fork,
                                        'gear' => $listingcategory->gear,
                                        'more_details' => $listingcategory->more_details,

                                    ],


                                    'created_at' => $listingcategory->created_at,
                                    'reservations' => $reservations->map(function ($reservation) {
                                        return [
                                            'start' => $reservation->reservationstart,
                                            'end' => $reservation->reservationsend,
                                        ];
                                    }),

                                    'reviewslistings' => $reviewslistings->map(function ($review) {

                                        $user = User::find($review->user_id);

                                        return [
                                            'id' => $review->id, // Ensure id is included

                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'message' => $review->description,
                                            'helpful' => $review->like,
                                            'profile_image' => $user->profile_image,

                                            'created_at' => $review->created_at->toIso8601String(),


                                            'replies' => $review->reviewreply->map(function ($reply) {

                                                $replyUser = User::find($reply->user_id);

                                            return [
                                                'id' => $reply->id,
                                                'name' => $reply->name,
                                                'picture' => $reply->picture,
                                                'profile_image' => $replyUser->profile_image,
                                                'message' => $reply->message,
                                                'created_at' => $reply->created_at->toIso8601String(),
                                            ];
                                        }),




                                        ];
                                    }),




                                    'images' => Velosimg::where('velo_id', $listingcategory->id)->get()->map(function ($image) {
                                        return $image->picture;
                                    }),

                                    'seller' => [
                                        'name' => $user->name,
                                        'id' => $user->id,
                                        'profile_image' => $user->profile_image,
                                        'created_at' => $user->created_at->toIso8601String(),
                                        'url' => $userStore ? $userStore->url : null,  // Add the store URL here

                                    ],


                                    'total_reviews' => $totalReviews,
                                    'average_rating' => round($averageRating, 1), // Rounded to one decimal place









                                    'recentlistings' => Velo::orderBy('created_at', 'desc')->take(10)->get()->map(function ($recentlisting) {

                                        $user = User::where('id', $recentlisting->user_id)->first();

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [

                                            'attributes' => [

                                                'phone' => $recentlisting->phone,
                                                'averageRating' => $averageRating,

                                                'seller' => [
                                                    'name' => $user->name,
                                                    'id' => $user->id,
                                                    'profile_image' => $user->profile_image,
                                                    'created_at' => $user->created_at->toIso8601String(),

                                                ],

                                            'title' => $recentlisting->title,
                                            'price' => $recentlisting->price,
                                            'city' => $recentlisting->city,
                                            'id' => $recentlisting->id,
                                            'category' => 'velos',
                                            'url' => $recentlisting->url,
                                            'created_at' => $recentlisting->created_at->toIso8601String(),
                                                                                                                                            'picture' => $recentlisting->picture,



                                            'images' => $recentlisting->servicesimg->map(function ($image) {
                                                return [

                                                    'picturesmall' => $image->picturesmall,
                                                    'alttext' => $image->alttext,
                                                ];
                                            }),

                                            ],

                                        ];
                                    }),


                                    'recentlistingscasablanca' => Velo::where('city', 'Casablanca')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews


                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,

                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                            ],
                                        ];
                                    }),

                                    'recentlistingsmarrakech' => Velo::where('city', 'Marrakech')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingstanger' => Velo::where('city', 'Tanger')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),




                                    'recentlistingsrabat' => Velo::where('city', 'Rabat')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsfes' => Velo::where('city', 'Fes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsagadir' => Velo::where('city', 'Agadir')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsmeknes' => Velo::where('city', 'Meknes')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),

                                    'recentlistingsojuda' => Velo::where('city', 'Oujda')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews

                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),






                                    'recentlistingskenitra' => Velo::where('city', 'Kenitra')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstetouan' => Velo::where('city', 'Tetouan')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssale' => Velo::where('city', 'SalÃ©')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingstemara' => Velo::where('city', 'Temara')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingssafi' => Velo::where('city', 'Safi')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsmohammedia' => Velo::where('city', 'Mohammedia')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingskhouribga' => Velo::where('city', 'Khouribga')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentListingseljadida' => Velo::where('city', 'El Jadida')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),
                                    'recentlistingsbenimellal' => Velo::where('city', 'Beni Mellal')->orderBy('created_at', 'desc')->take(12)->get()->map(function ($recentlisting) {

                                        $reviews = $recentlisting->review()->orderBy('created_at')->get();
                                        $totalReviews = $reviews->count();
                                        $averageRating = $totalReviews > 0 ? $reviews->avg('rating') : 5; // Default to 5 if no reviews
                                        return [
                                            'attributes' => [
                                                'title' => $recentlisting->title,
                                                'price' => $recentlisting->price,
                                                'city' => $recentlisting->city,
                                                'id' => $recentlisting->id,
                                                'category' => 'velos',
                                                'url' => $recentlisting->url,
                                                'created_at' => $recentlisting->created_at->toIso8601String(),
                                                'picture' => $recentlisting->picture,

                                                'averageRating' => $averageRating,
                                                'totalReviews' => $totalReviews,
                                            ],
                                        ];
                                    }),











                                ],

                        ];


                        // Build the response data
                        $responseData = [
                            'data' => $listingsData,
                        ];

                        // Conditionally add 'favorites' if the user is authenticated
                        if (isset($favoriteIds)) {
                            $responseData['favorites'] = $favoriteIds;
                        }

                        // Return the JSON response
                        return response()->json($responseData);


                break;






            default:
                // Default code
                break;
        }








    }


    public function getListingpic(Request $request, $category, $url)
    {


        switch ($category) {
            case 'apartments':
                $listingCategory = Apartment::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {


                    return $image->picturesxlarge;
                });
                break;

            case 'billiards':
                $listingCategory = Billiard::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'activities':
                $listingCategory = Activity::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'audios':
                $listingCategory = Audio::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'boats':
                $listingCategory = Boat::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'boxings':
                $listingCategory = Boxing::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'bureauxs':
                $listingCategory = Bureaux::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'cameras':
                $listingCategory = Camera::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'camions':
                $listingCategory = Camion::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'caravans':
                $listingCategory = Caravan::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'cars':
                $listingCategory = Car::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'chargers':
                $listingCategory = Charger::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'clothes':
                $listingCategory = Clothes::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'divings':
                $listingCategory = Diving::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'drones':
                $listingCategory = Drone::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'eclairages':
                $listingCategory = Eclairage::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'electricaltools':
                $listingCategory = Electricaltool::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'engins':
                $listingCategory = Engin::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'footballs':
                $listingCategory = Football::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'furnitures':
                $listingCategory = Furniture::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'gamings':
                $listingCategory = Gaming::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'golfs':
                $listingCategory = Golf::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'houseappliances':
                $listingCategory = Houseappliance::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'huntings':
                $listingCategory = Hunting::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'jewelrys':
                $listingCategory = Jewelry::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'ladders':
                $listingCategory = Ladder::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'laptops':
                $listingCategory = Laptop::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'lightings':
                $listingCategory = Lighting::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'livres':
                $listingCategory = Livre::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'magasins':
                $listingCategory = Magasin::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'maisons':
                $listingCategory = Maison::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'mechanicaltools':
                $listingCategory = Mechanicaltool::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'mobiliers':
                $listingCategory = Mobilier::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'motos':
                $listingCategory = Moto::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'musculations':
                $listingCategory = Musculation::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'musicals':
                $listingCategory = Musical::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'photographies':
                $listingCategory = Photographie::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'powertools':
                $listingCategory = Powertool::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'pressurewashers':
                $listingCategory = Pressurewasher::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'printers':
                $listingCategory = Printer::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'riads':
                $listingCategory = Riad::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'routers':
                $listingCategory = Router::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'scooters':
                $listingCategory = Scooter::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'services':
                $listingCategory = Service::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'sonorisations':
                $listingCategory = Sonorisation::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'surfs':
                $listingCategory = Surf::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'tablettes':
                $listingCategory = Tablette::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'taxiaeroports':
                $listingCategory = Taxiaeroport::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'tennis':
                $listingCategory = Tennis::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'tentes':
                $listingCategory = Tente::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'terrains':
                $listingCategory = Terrain::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'transportations':
                $listingCategory = Transportation::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'velos':
                $listingCategory = Velo::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            case 'villas':
                $listingCategory = Villa::where('url', $url)->first();
                $images = $listingCategory->servicesimg->map(function ($image) {

                    return $image->picturesxlarge;
                });
                break;

            default:
                $listingCategory = null; // Or handle the default case as needed
                $images = [];
                break;
        }


        if ($listingCategory) {
            return response()->json([


                'images' => $images,
            ]);
        } else {
            return response()->json(['message' => 'Invalid category or no listing found'], 404);
        }

    }



    public function createReview(Request $request, $category, $url)
    {



                // Validate the request data
                $validatedData = $request->validate([
                    'name' => 'required|string|max:255',
                    'email' => 'required|email|max:255',
                    'description' => 'required|string|max:255',
                    'rating' => 'required|numeric|min:1|max:5',

                ]);











            switch ($category) {



                        case 'billiards':



                            $listingcategory = Billiard::where('url', $url)->first();



                                $review = Review::create([
                                    'name' => $validatedData['name'],
                                    'rating' => $validatedData['rating'],
                                    'email' => $validatedData['email'],
                                    'url' =>$url ,
                                    'category' =>$category ,
                                    'listings_thumb' =>$listingcategory->picture ,
                                    'listings_title' =>$listingcategory->title ,
                                    'listings_price' =>$listingcategory->price ,

                                    'description' =>$validatedData['description'],



                                    'billiard_id' =>$listingcategory->id,
                                    'user_id'=> $listingcategory->user_id,

                                    'onlinestore_id'=> $listingcategory->user_id,


                                ]);




                                return response()->json([
                                    'data' => [
                                        'type' => $category,
                                        'id' => $review->id,
                                        'attributes' => [
                                            'name' => $review->name,
                                            'rating' => $review->rating,
                                            'description' => $review->description,
                                            'created_at' => $review->created_at->toIso8601String(),





                                        ],
                                    ],
                                ]);





                        break;





                        case 'boxings':



                            $listingcategory = Boxing::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'boxing_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'divings':



                            $listingcategory = Diving::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'diving_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'footballs':



                            $listingcategory = Football::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'football_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'golfs':



                            $listingcategory = Golf::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'golf_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;








                        case 'huntings':



                            $listingcategory = Hunting::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'hunting_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'musculations':



                            $listingcategory = Musculation::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'musculation_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;








                        case 'surfs':



                            $listingcategory = Surf::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'surf_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'tennis':



                            $listingcategory = Tennis::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'tennis_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'audios':



                            $listingcategory = Audio::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'audio_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'cameras':



                            $listingcategory = Camera::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'camera_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'chargers':



                            $listingcategory = Charger::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'charger_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);






                            break;






                        case 'drones':



                            $listingcategory = Drone::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'drone_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;









                        case 'gamings':



                            $listingcategory = Gaming::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'gaming_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'laptops':



                            $listingcategory = Laptop::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'laptop_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;








                        case 'lightings':



                            $listingcategory = Lighting::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'lighting_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;








                        case 'printers':



                            $listingcategory = Printer::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'printer_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'routers':



                            $listingcategory = Router::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'router_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);






                            break;







                        case 'tablettes':



                            $listingcategory = Tablette::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'tablette_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);






                            break;







                        case 'eclairages':



                            $listingcategory = Eclairage::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'eclairage_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'mobiliers':



                            $listingcategory = Mobilier::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'mobilier_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'photographies':



                            $listingcategory = Photographie::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'photographie_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'sonorisations':



                            $listingcategory = Sonorisation::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'sonorisation_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);






                            break;







                        case 'tentes':



                            $listingcategory = Tente::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'tente_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'clothes':



                            $listingcategory = Clothes::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'clothes_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'jewelrys':



                            $listingcategory = Jewelry::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'jewelry_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'apartments':



                            $listingcategory = Apartment::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'apartment_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'bureauxs':



                            $listingcategory = Bureaux::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'bureaux_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);






                            break;






                        case 'magasins':



                            $listingcategory = Magasin::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'magasin_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'maisons':



                            $listingcategory = Maison::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'maison_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'riads':



                            $listingcategory = Riad::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'riad_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;





                        case 'terrains':



                            $listingcategory = Terrain::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'terrain_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;







                        case 'villas':



                            $listingcategory = Villa::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'villa_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'activities':



                            $listingcategory = Activity::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'activity_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'livres':



                            $listingcategory = Livre::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'livre_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'musicals':



                            $listingcategory = Musical::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'musical_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'furnitures':



                            $listingcategory = Furniture::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'furniture_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'houseappliances':



                            $listingcategory = Houseappliance::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'houseappliance_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'electricaltools':



                            $listingcategory = Electricaltool::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'electricaltool_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);






                            break;






                        case 'ladders':



                            $listingcategory = Ladder::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'ladder_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'mechanicaltools':



                            $listingcategory = Mechanicaltool::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'mechanicaltool_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;





                        case 'powertools':



                            $listingcategory = Powertool::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'powertool_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'pressurewashers':



                            $listingcategory = Pressurewasher::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'pressurewasher_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'services':



                            $listingcategory = Service::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'service_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);





                            break;






                        case 'boats':



                            $listingcategory = Boat::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'boat_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;






                        case 'camions':



                            $listingcategory = Camion::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'camion_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;





                        case 'caravans':



                            $listingcategory = Caravan::where('url', $url)->first();



                            $review = Review::create([
                                'name' => $validatedData['name'],
                                'rating' => $validatedData['rating'],
                                'email' => $validatedData['email'],
                                'url' =>$url ,
                                'category' =>$category ,
                                'listings_thumb' =>$listingcategory->picture ,
                                'listings_title' =>$listingcategory->title ,
                                'listings_price' =>$listingcategory->price ,

                                'description' =>$validatedData['description'],



                                'caravan_id' =>$listingcategory->id,
                                'user_id'=> $listingcategory->user_id,

                                'onlinestore_id'=> $listingcategory->user_id,


                            ]);




                            return response()->json([
                                'data' => [
                                    'type' => $category,
                                    'id' => $review->id,
                                    'attributes' => [
                                        'name' => $review->name,
                                        'rating' => $review->rating,
                                        'description' => $review->description,
                                        'created_at' => $review->created_at->toIso8601String(),





                                    ],
                                ],
                            ]);




                            break;





                        case 'cars':



                        $listingcategory = Car::where('url', $url)->first();



                        $review = Review::create([
                            'name' => $validatedData['name'],
                            'rating' => $validatedData['rating'],
                            'email' => $validatedData['email'],
                            'url' =>$url ,
                            'category' =>$category ,
                            'listings_thumb' =>$listingcategory->picture ,
                            'listings_title' =>$listingcategory->title ,
                            'listings_price' =>$listingcategory->price ,

                            'description' =>$validatedData['description'],



                            'car_id' =>$listingcategory->id,
                            'user_id'=> $listingcategory->user_id,

                            'onlinestore_id'=> $listingcategory->user_id,


                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $review->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'rating' => $review->rating,
                                    'description' => $review->description,
                                    'created_at' => $review->created_at->toIso8601String(),





                                ],
                            ],
                        ]);





                        break;





                    case 'engins':



                        $listingcategory = Engin::where('url', $url)->first();



                        $review = Review::create([
                            'name' => $validatedData['name'],
                            'rating' => $validatedData['rating'],
                            'email' => $validatedData['email'],
                            'url' =>$url ,
                            'category' =>$category ,
                            'listings_thumb' =>$listingcategory->picture ,
                            'listings_title' =>$listingcategory->title ,
                            'listings_price' =>$listingcategory->price ,

                            'description' =>$validatedData['description'],



                            'engin_id' =>$listingcategory->id,
                            'user_id'=> $listingcategory->user_id,

                            'onlinestore_id'=> $listingcategory->user_id,


                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $review->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'rating' => $review->rating,
                                    'description' => $review->description,
                                    'created_at' => $review->created_at->toIso8601String(),





                                ],
                            ],
                        ]);






                        break;





                    case 'motos':



                        $listingcategory = Moto::where('url', $url)->first();



                        $review = Review::create([
                            'name' => $validatedData['name'],
                            'rating' => $validatedData['rating'],
                            'email' => $validatedData['email'],
                            'url' =>$url ,
                            'category' =>$category ,
                            'listings_thumb' =>$listingcategory->picture ,
                            'listings_title' =>$listingcategory->title ,
                            'listings_price' =>$listingcategory->price ,

                            'description' =>$validatedData['description'],



                            'moto_id' =>$listingcategory->id,
                            'user_id'=> $listingcategory->user_id,

                            'onlinestore_id'=> $listingcategory->user_id,


                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $review->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'rating' => $review->rating,
                                    'description' => $review->description,
                                    'created_at' => $review->created_at->toIso8601String(),





                                ],
                            ],
                        ]);





                        break;





                    case 'scooters':



                        $listingcategory = Scooter::where('url', $url)->first();



                        $review = Review::create([
                            'name' => $validatedData['name'],
                            'rating' => $validatedData['rating'],
                            'email' => $validatedData['email'],
                            'url' =>$url ,
                            'category' =>$category ,
                            'listings_thumb' =>$listingcategory->picture ,
                            'listings_title' =>$listingcategory->title ,
                            'listings_price' =>$listingcategory->price ,

                            'description' =>$validatedData['description'],



                            'scooter_id' =>$listingcategory->id,
                            'user_id'=> $listingcategory->user_id,

                            'onlinestore_id'=> $listingcategory->user_id,


                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $review->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'rating' => $review->rating,
                                    'description' => $review->description,
                                    'created_at' => $review->created_at->toIso8601String(),





                                ],
                            ],
                        ]);





                        break;






                    case 'taxiaeroports':



                        $listingcategory = Taxiaeroport::where('url', $url)->first();



                        $review = Review::create([
                            'name' => $validatedData['name'],
                            'rating' => $validatedData['rating'],
                            'email' => $validatedData['email'],
                            'url' =>$url ,
                            'category' =>$category ,
                            'listings_thumb' =>$listingcategory->picture ,
                            'listings_title' =>$listingcategory->title ,
                            'listings_price' =>$listingcategory->price ,

                            'description' =>$validatedData['description'],



                            'taxiaeroport_id' =>$listingcategory->id,
                            'user_id'=> $listingcategory->user_id,

                            'onlinestore_id'=> $listingcategory->user_id,


                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $review->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'rating' => $review->rating,
                                    'description' => $review->description,
                                    'created_at' => $review->created_at->toIso8601String(),





                                ],
                            ],
                        ]);





                        break;





                    case 'transportations':



                        $listingcategory = Transportation::where('url', $url)->first();



                        $review = Review::create([
                            'name' => $validatedData['name'],
                            'rating' => $validatedData['rating'],
                            'email' => $validatedData['email'],
                            'url' =>$url ,
                            'category' =>$category ,
                            'listings_thumb' =>$listingcategory->picture ,
                            'listings_title' =>$listingcategory->title ,
                            'listings_price' =>$listingcategory->price ,

                            'description' =>$validatedData['description'],



                            'transportation_id' =>$listingcategory->id,
                            'user_id'=> $listingcategory->user_id,

                            'onlinestore_id'=> $listingcategory->user_id,


                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $review->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'rating' => $review->rating,
                                    'description' => $review->description,
                                    'created_at' => $review->created_at->toIso8601String(),





                                ],
                            ],
                        ]);





                        break;







                    case 'velos':



                        $listingcategory = Velo::where('url', $url)->first();



                        $review = Review::create([
                            'name' => $validatedData['name'],
                            'rating' => $validatedData['rating'],
                            'email' => $validatedData['email'],
                            'url' =>$url ,
                            'category' =>$category ,
                            'listings_thumb' =>$listingcategory->picture ,
                            'listings_title' =>$listingcategory->title ,
                            'listings_price' =>$listingcategory->price ,

                            'description' =>$validatedData['description'],



                            'velo_id' =>$listingcategory->id,
                            'user_id'=> $listingcategory->user_id,

                            'onlinestore_id'=> $listingcategory->user_id,


                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $review->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'rating' => $review->rating,
                                    'description' => $review->description,
                                    'created_at' => $review->created_at->toIso8601String(),





                                ],
                            ],
                        ]);





                        break;






                    default:
                        // Default code
                        break;
            }






    }




    public function addToHelpful(Request $request, $category, $url, $reviewId)
    {
        $review = Review::find($reviewId);

        if ($review) {
            $review->like += 1;
            $review->save();

            return response()->json([
                'success' => true,
                'likes' => $review->like
            ]);
        }

        return response()->json(['success' => false], 404);
    }



    public function createReviewReply(Request $request, $category, $url, $reviewId)
    {
                        $review = Review::find($reviewId);

                        $user = Auth::user();

                        // Validate the request data
                        $validatedData = $request->validate([
                            'message' => 'required|string|max:255',


                        ]);




                        $Reviewreply = Reviewreply::create([
                            'message' => $validatedData['message'],


                            'picture' => $user->profile_image ,
                            'name' => $user->name ,
                            'email' => $user->email ,




                            'review_id' =>$reviewId,
                            'user_id'=> $user->id,

                        ]);




                        return response()->json([
                            'data' => [
                                'type' => $category,
                                'id' => $Reviewreply->id,
                                'attributes' => [
                                    'name' => $review->name,
                                    'message' => $Reviewreply->message,
                                    'picture' => $Reviewreply->picture,
                                    'created_at' => $Reviewreply->created_at->toIso8601String(),





                                ],
                            ],
                        ]);



    }



}
